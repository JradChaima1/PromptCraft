<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Culling System Verification</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
        }
        
        .test-section {
            background: #2a2a2a;
            border: 2px solid #00ff00;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .test-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #00cc00;
            box-shadow: 0 0 10px #00ff00;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #1a1a1a;
            border: 1px solid #00ff00;
            border-radius: 4px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #00ff00;
        }
        
        .log-container {
            background: #000;
            border: 1px solid #00ff00;
            border-radius: 4px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #00ff00;
            padding-left: 10px;
        }
        
        .log-entry.info { border-left-color: #00aaff; color: #00aaff; }
        .log-entry.success { border-left-color: #00ff00; color: #00ff00; }
        .log-entry.warning { border-left-color: #ffaa00; color: #ffaa00; }
        .log-entry.error { border-left-color: #ff0000; color: #ff0000; }
        
        #game-container {
            border: 2px solid #00ff00;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ® Culling System Verification Test</h1>
        
        <div class="test-section">
            <h2>Test Controls</h2>
            <div class="test-controls">
                <button onclick="testBasicCulling()">Test Basic Culling</button>
                <button onclick="testCameraMovement()">Test Camera Movement</button>
                <button onclick="testCullingMargin()">Test Culling Margin</button>
                <button onclick="testToggleCulling()">Toggle Culling On/Off</button>
                <button onclick="clearAssets()">Clear All Assets</button>
            </div>
        </div>
        
        <div class="test-section">
            <h2>Culling Statistics</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Assets</div>
                    <div class="stat-value" id="stat-total">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Visible Assets</div>
                    <div class="stat-value" id="stat-visible">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Culled Assets</div>
                    <div class="stat-value" id="stat-culled">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Culling Enabled</div>
                    <div class="stat-value" id="stat-enabled">Yes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Culling Margin</div>
                    <div class="stat-value" id="stat-margin">100px</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Camera Position</div>
                    <div class="stat-value" id="stat-camera">0, 0</div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>Test Log</h2>
            <div class="log-container" id="log-container"></div>
        </div>
        
        <div id="game-container"></div>
    </div>

    <script type="module">
        import Phaser from 'phaser';
        import WorldManager from './src/managers/WorldManager.js';
        import StorageService from './src/services/StorageService.js';

        let game;
        let worldManager;
        let storageService;
        let testScene;

        // Logging function
        function log(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(message);
        }

        // Update statistics display
        function updateStats() {
            if (!worldManager) return;
            
            const cullingStats = worldManager.getCullingStats();
            const camera = testScene.cameras.main;
            
            document.getElementById('stat-total').textContent = cullingStats.total;
            document.getElementById('stat-visible').textContent = cullingStats.visible;
            document.getElementById('stat-culled').textContent = cullingStats.culled;
            document.getElementById('stat-enabled').textContent = cullingStats.cullingEnabled ? 'Yes' : 'No';
            document.getElementById('stat-margin').textContent = worldManager.cullingMargin + 'px';
            document.getElementById('stat-camera').textContent = 
                `${Math.round(camera.scrollX)}, ${Math.round(camera.scrollY)}`;
        }

        // Test Scene
        class TestScene extends Phaser.Scene {
            constructor() {
                super({ key: 'TestScene' });
            }

            preload() {
                // Create test textures
                const graphics = this.add.graphics();
                
                // Red square
                graphics.fillStyle(0xff0000, 1);
                graphics.fillRect(0, 0, 32, 32);
                graphics.generateTexture('test-red', 32, 32);
                
                // Blue square
                graphics.clear();
                graphics.fillStyle(0x0000ff, 1);
                graphics.fillRect(0, 0, 32, 32);
                graphics.generateTexture('test-blue', 32, 32);
                
                // Green square
                graphics.clear();
                graphics.fillStyle(0x00ff00, 1);
                graphics.fillRect(0, 0, 32, 32);
                graphics.generateTexture('test-green', 32, 32);
                
                graphics.destroy();
            }

            create() {
                testScene = this;
                
                // Set world bounds
                this.physics.world.setBounds(0, 0, 2000, 2000);
                this.cameras.main.setBounds(0, 0, 2000, 2000);
                
                // Initialize services
                storageService = new StorageService();
                worldManager = new WorldManager(this, storageService);
                
                // Make available globally for tests
                window.worldManager = worldManager;
                window.testScene = this;
                
                log('Test scene initialized', 'success');
                log('Culling system ready for testing', 'info');
            }

            update() {
                // Update culling every frame
                if (worldManager) {
                    worldManager.updateCulling();
                }
                
                // Update stats periodically
                if (this.time.now % 500 < 20) {
                    updateStats();
                }
            }
        }

        // Initialize Phaser game
        const config = {
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            parent: 'game-container',
            backgroundColor: '#222222',
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 0 },
                    debug: false
                }
            },
            scene: [TestScene]
        };

        game = new Phaser.Game(config);

        // Test Functions
        window.testBasicCulling = function() {
            log('=== Testing Basic Culling ===', 'info');
            
            // Clear existing assets
            worldManager.clearWorld(true, true);
            
            // Place assets in a grid pattern
            const gridSize = 10;
            const spacing = 200;
            let placedCount = 0;
            
            for (let x = 0; x < gridSize; x++) {
                for (let y = 0; y < gridSize; y++) {
                    const posX = x * spacing + 100;
                    const posY = y * spacing + 100;
                    
                    worldManager.addPlacedAsset({
                        assetId: `test-asset-${x}-${y}`,
                        textureKey: 'test-red',
                        position: { x: posX, y: posY },
                        rotation: 0,
                        scale: { x: 1, y: 1 },
                        collisionEnabled: false,
                        zIndex: 0
                    });
                    placedCount++;
                }
            }
            
            log(`Placed ${placedCount} assets in ${gridSize}x${gridSize} grid`, 'success');
            
            // Reset camera to origin
            testScene.cameras.main.setScroll(0, 0);
            
            setTimeout(() => {
                const stats = worldManager.getCullingStats();
                log(`Initial culling: ${stats.visible} visible, ${stats.culled} culled`, 'success');
                updateStats();
            }, 100);
        };

        window.testCameraMovement = function() {
            log('=== Testing Camera Movement Culling ===', 'info');
            
            const camera = testScene.cameras.main;
            const positions = [
                { x: 0, y: 0, label: 'Top-Left' },
                { x: 1000, y: 0, label: 'Top-Right' },
                { x: 0, y: 1000, label: 'Bottom-Left' },
                { x: 1000, y: 1000, label: 'Bottom-Right' },
                { x: 500, y: 500, label: 'Center' }
            ];
            
            let index = 0;
            
            function moveToNext() {
                if (index >= positions.length) {
                    log('Camera movement test complete', 'success');
                    return;
                }
                
                const pos = positions[index];
                camera.setScroll(pos.x, pos.y);
                log(`Moved camera to ${pos.label} (${pos.x}, ${pos.y})`, 'info');
                
                setTimeout(() => {
                    const stats = worldManager.getCullingStats();
                    log(`  â†’ ${stats.visible} visible, ${stats.culled} culled`, 'success');
                    updateStats();
                    
                    index++;
                    setTimeout(moveToNext, 500);
                }, 100);
            }
            
            moveToNext();
        };

        window.testCullingMargin = function() {
            log('=== Testing Culling Margin ===', 'info');
            
            const margins = [0, 50, 100, 200, 500];
            let index = 0;
            
            // Reset camera
            testScene.cameras.main.setScroll(400, 400);
            
            function testNextMargin() {
                if (index >= margins.length) {
                    log('Culling margin test complete', 'success');
                    worldManager.setCullingMargin(100); // Reset to default
                    return;
                }
                
                const margin = margins[index];
                worldManager.setCullingMargin(margin);
                log(`Set culling margin to ${margin}px`, 'info');
                
                setTimeout(() => {
                    const stats = worldManager.getCullingStats();
                    log(`  â†’ ${stats.visible} visible, ${stats.culled} culled`, 'success');
                    updateStats();
                    
                    index++;
                    setTimeout(testNextMargin, 800);
                }, 100);
            }
            
            testNextMargin();
        };

        window.testToggleCulling = function() {
            log('=== Testing Culling Toggle ===', 'info');
            
            const currentState = worldManager.cullingEnabled;
            worldManager.setCullingEnabled(!currentState);
            
            setTimeout(() => {
                const stats = worldManager.getCullingStats();
                log(`Culling ${!currentState ? 'enabled' : 'disabled'}`, 'success');
                log(`  â†’ ${stats.visible} visible, ${stats.culled} culled`, 'info');
                updateStats();
            }, 100);
        };

        window.clearAssets = function() {
            log('Clearing all assets...', 'info');
            worldManager.clearWorld(true, true);
            testScene.cameras.main.setScroll(0, 0);
            updateStats();
            log('All assets cleared', 'success');
        };

        // Initial stats update
        setTimeout(() => {
            updateStats();
            log('Ready for testing!', 'success');
        }, 500);
    </script>
</body>
</html>
