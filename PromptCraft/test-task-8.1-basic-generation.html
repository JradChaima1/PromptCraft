<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Task 8.1: Basic Generation Functionality Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1400px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .header {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 { color: #333; margin: 0 0 10px 0; }
    .task-info {
      color: #666;
      font-size: 14px;
      margin-top: 10px;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h2 { color: #666; margin-top: 0; }
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    button {
      padding: 12px 24px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }
    button:hover { background: #45a049; }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    button.secondary {
      background: #2196F3;
    }
    button.secondary:hover {
      background: #0b7dda;
    }
    .test-result {
      margin: 10px 0;
      padding: 12px;
      border-radius: 4px;
      font-size: 14px;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    .image-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .image-card {
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      background: #fafafa;
      transition: transform 0.2s;
    }
    .image-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .image-card img {
      width: 100%;
      height: auto;
      border-radius: 4px;
      image-rendering: pixelated;
      background: white;
      border: 1px solid #ddd;
    }
    .image-info {
      margin-top: 12px;
      font-size: 13px;
      color: #666;
    }
    .image-info div {
      margin: 5px 0;
      padding: 4px 0;
      border-bottom: 1px solid #eee;
    }
    .image-info div:last-child {
      border-bottom: none;
    }
    .image-info strong {
      color: #333;
      display: inline-block;
      min-width: 80px;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
      vertical-align: middle;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .summary {
      background: #e8f5e9;
      padding: 15px;
      border-radius: 4px;
      margin-top: 20px;
      border-left: 4px solid #4CAF50;
    }
    .summary h3 {
      margin: 0 0 10px 0;
      color: #2e7d32;
    }
    .summary-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .stat {
      background: white;
      padding: 10px;
      border-radius: 4px;
      text-align: center;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #4CAF50;
    }
    .stat-label {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üß™ Task 8.1: Basic Generation Functionality Test</h1>
    <div class="task-info">
      <strong>Requirements:</strong> 1.1, 1.2, 1.3, 1.4, 1.5, 3.1, 3.2, 3.3<br>
      <strong>Test Objectives:</strong>
      <ul style="margin: 10px 0 0 20px;">
        <li>Generate images with default settings</li>
        <li>Test each model (turbo, flux, flux-realism, flux-anime, flux-3d)</li>
        <li>Verify images load correctly</li>
        <li>Verify asset metadata is correct</li>
      </ul>
    </div>
  </div>
  
  <div class="test-section">
    <h2>üìã Test Execution</h2>
    
    <div class="controls">
      <button onclick="runTest1()">1. Test Default Generation (Turbo)</button>
      <button onclick="runTest2()">2. Test All Models</button>
      <button onclick="runAllTests()" class="secondary">‚ñ∂ Run All Tests</button>
      <button onclick="clearResults()">Clear Results</button>
    </div>
    
    <div id="test-results"></div>
    
    <div id="summary-container"></div>
  </div>

  <div class="test-section">
    <h2>üñºÔ∏è Generated Images</h2>
    <div id="image-results" class="image-grid"></div>
  </div>

  <script type="module">
    import PollinationsAPIService from './src/services/PollinationsAPIService.js';
    
    // Initialize service
    window.apiService = new PollinationsAPIService();
    window.testStats = {
      total: 0,
      passed: 0,
      failed: 0,
      totalTime: 0
    };
    
    // Helper functions
    window.addResult = function(message, type = 'info') {
      const container = document.getElementById('test-results');
      const result = document.createElement('div');
      result.className = `test-result ${type}`;
      result.innerHTML = message;
      container.appendChild(result);
      container.scrollTop = container.scrollHeight;
    };
    
    window.addImage = function(imageData, metadata) {
      const container = document.getElementById('image-results');
      const card = document.createElement('div');
      card.className = 'image-card';
      
      const img = document.createElement('img');
      img.src = imageData;
      img.alt = metadata.description || 'Generated image';
      
      const info = document.createElement('div');
      info.className = 'image-info';
      info.innerHTML = `
        <div><strong>Description:</strong> ${metadata.description || 'N/A'}</div>
        <div><strong>Model:</strong> ${metadata.model || 'N/A'}</div>
        <div><strong>Seed:</strong> ${metadata.seed || 'Random'}</div>
        <div><strong>Size:</strong> ${metadata.width}x${metadata.height}</div>
        <div><strong>Time:</strong> ${metadata.generationTime ? (metadata.generationTime/1000).toFixed(2) + 's' : 'N/A'}</div>
      `;
      
      card.appendChild(img);
      card.appendChild(info);
      container.appendChild(card);
    };
    
    window.clearResults = function() {
      document.getElementById('test-results').innerHTML = '';
      document.getElementById('image-results').innerHTML = '';
      document.getElementById('summary-container').innerHTML = '';
      window.testStats = {
        total: 0,
        passed: 0,
        failed: 0,
        totalTime: 0
      };
    };
    
    window.updateSummary = function() {
      const container = document.getElementById('summary-container');
      const passRate = window.testStats.total > 0 
        ? ((window.testStats.passed / window.testStats.total) * 100).toFixed(1)
        : 0;
      
      container.innerHTML = `
        <div class="summary">
          <h3>üìä Test Summary</h3>
          <div class="summary-stats">
            <div class="stat">
              <div class="stat-value">${window.testStats.total}</div>
              <div class="stat-label">Total Tests</div>
            </div>
            <div class="stat">
              <div class="stat-value" style="color: #4CAF50;">${window.testStats.passed}</div>
              <div class="stat-label">Passed</div>
            </div>
            <div class="stat">
              <div class="stat-value" style="color: #f44336;">${window.testStats.failed}</div>
              <div class="stat-label">Failed</div>
            </div>
            <div class="stat">
              <div class="stat-value">${passRate}%</div>
              <div class="stat-label">Pass Rate</div>
            </div>
            <div class="stat">
              <div class="stat-value">${(window.testStats.totalTime/1000).toFixed(1)}s</div>
              <div class="stat-label">Total Time</div>
            </div>
          </div>
        </div>
      `;
    };
    
    // Test 1: Default Generation with Turbo Model
    window.runTest1 = async function() {
      addResult('üîÑ <strong>Test 1:</strong> Testing default generation with turbo model...', 'info');
      window.testStats.total++;
      
      try {
        const startTime = Date.now();
        const result = await window.apiService.generateImage({
          description: 'a small pixel art tree with green leaves',
          imageSize: { width: 64, height: 64 }
        });
        const endTime = Date.now();
        const duration = endTime - startTime;
        window.testStats.totalTime += duration;
        
        // Verify result structure
        if (!result) {
          throw new Error('No result returned');
        }
        
        if (!result.imageData) {
          throw new Error('No imageData in result');
        }
        
        if (!result.metadata) {
          throw new Error('No metadata in result');
        }
        
        // Verify imageData is base64
        if (!result.imageData.startsWith('data:image/')) {
          throw new Error('imageData is not a valid base64 data URL');
        }
        
        // Verify metadata structure
        if (!result.metadata.model) {
          throw new Error('metadata.model is missing');
        }
        
        if (result.metadata.model !== 'turbo') {
          throw new Error(`Expected model "turbo", got "${result.metadata.model}"`);
        }
        
        if (!result.metadata.generationURL) {
          throw new Error('metadata.generationURL is missing');
        }
        
        // Success!
        window.testStats.passed++;
        addResult(`‚úÖ <strong>Test 1 PASSED:</strong> Default generation successful! (${(duration/1000).toFixed(2)}s)`, 'success');
        addResult(`&nbsp;&nbsp;&nbsp;‚úì Image data is valid base64`, 'success');
        addResult(`&nbsp;&nbsp;&nbsp;‚úì Metadata model is "turbo"`, 'success');
        addResult(`&nbsp;&nbsp;&nbsp;‚úì Generation URL is present`, 'success');
        
        addImage(result.imageData, {
          description: 'pixel art tree',
          model: result.metadata.model,
          seed: result.metadata.seed,
          width: 64,
          height: 64,
          generationTime: duration
        });
        
      } catch (error) {
        window.testStats.failed++;
        addResult(`‚ùå <strong>Test 1 FAILED:</strong> ${error.message}`, 'error');
        console.error('Test 1 error:', error);
      }
      
      updateSummary();
    };
    
    // Test 2: All Models
    window.runTest2 = async function() {
      const models = ['turbo', 'flux', 'flux-realism', 'flux-anime', 'flux-3d'];
      addResult(`üîÑ <strong>Test 2:</strong> Testing all ${models.length} models...`, 'info');
      
      const descriptions = {
        'turbo': 'a small pixel art house',
        'flux': 'a pixel art sword',
        'flux-realism': 'a pixel art gem',
        'flux-anime': 'a pixel art character',
        'flux-3d': 'a pixel art coin'
      };
      
      for (const model of models) {
        window.testStats.total++;
        
        try {
          addResult(`&nbsp;&nbsp;Testing model: <strong>${model}</strong>...`, 'info');
          const startTime = Date.now();
          
          const result = await window.apiService.generateImage({
            description: descriptions[model],
            imageSize: { width: 64, height: 64 },
            model: model
          });
          
          const endTime = Date.now();
          const duration = endTime - startTime;
          window.testStats.totalTime += duration;
          
          // Verify result
          if (!result || !result.imageData || !result.metadata) {
            throw new Error('Invalid result structure');
          }
          
          if (!result.imageData.startsWith('data:image/')) {
            throw new Error('Invalid imageData format');
          }
          
          if (result.metadata.model !== model) {
            throw new Error(`Expected model "${model}", got "${result.metadata.model}"`);
          }
          
          // Success!
          window.testStats.passed++;
          addResult(`&nbsp;&nbsp;‚úÖ Model "<strong>${model}</strong>" successful! (${(duration/1000).toFixed(2)}s)`, 'success');
          
          addImage(result.imageData, {
            description: descriptions[model],
            model: result.metadata.model,
            seed: result.metadata.seed,
            width: 64,
            height: 64,
            generationTime: duration
          });
          
        } catch (error) {
          window.testStats.failed++;
          addResult(`&nbsp;&nbsp;‚ùå Model "<strong>${model}</strong>" failed: ${error.message}`, 'error');
          console.error(`Model ${model} error:`, error);
        }
        
        updateSummary();
      }
      
      addResult(`‚úÖ <strong>Test 2 COMPLETED:</strong> All models tested!`, 'success');
    };
    
    // Run all tests
    window.runAllTests = async function() {
      clearResults();
      addResult('üöÄ <strong>Starting Task 8.1 Test Suite...</strong>', 'info');
      addResult('', 'info');
      
      await runTest1();
      addResult('', 'info');
      await runTest2();
      addResult('', 'info');
      
      const allPassed = window.testStats.failed === 0;
      if (allPassed) {
        addResult('üéâ <strong>ALL TESTS PASSED!</strong> Task 8.1 is complete.', 'success');
      } else {
        addResult(`‚ö†Ô∏è <strong>SOME TESTS FAILED:</strong> ${window.testStats.failed} out of ${window.testStats.total} tests failed.`, 'warning');
      }
    };
    
    // Initial message
    addResult('‚ÑπÔ∏è Task 8.1 test suite loaded. Click "Run All Tests" to begin.', 'info');
  </script>
</body>
</html>
