<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pollinations Generation Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 { color: #333; }
    h2 { color: #666; margin-top: 0; }
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    button {
      padding: 10px 20px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover { background: #45a049; }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .test-result {
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    .image-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .image-card {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      background: #fafafa;
    }
    .image-card img {
      width: 100%;
      height: auto;
      border-radius: 4px;
      image-rendering: pixelated;
    }
    .image-info {
      margin-top: 10px;
      font-size: 12px;
      color: #666;
    }
    .image-info div {
      margin: 3px 0;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    input, select {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #555;
    }
    .form-group {
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <h1>üß™ Pollinations Generation Test Suite</h1>
  
  <div class="test-section">
    <h2>Test 8.1: Basic Generation Functionality</h2>
    <p>Tests image generation with default settings and all available models.</p>
    
    <div class="controls">
      <button onclick="testDefaultGeneration()">Test Default Generation (Turbo)</button>
      <button onclick="testAllModels()">Test All Models</button>
      <button onclick="clearResults()">Clear Results</button>
    </div>
    
    <div id="test-results"></div>
    <div id="image-results" class="image-grid"></div>
  </div>

  <div class="test-section">
    <h2>Test 8.2: Seed Reproducibility</h2>
    <p>Tests that using the same seed produces identical images.</p>
    
    <div class="form-group">
      <label>Test Seed:</label>
      <input type="number" id="seedInput" value="12345" />
    </div>
    
    <div class="controls">
      <button onclick="testSeedReproducibility()">Test Seed Reproducibility</button>
      <button onclick="testRandomGeneration()">Test Random (No Seed)</button>
    </div>
    
    <div id="seed-results"></div>
    <div id="seed-images" class="image-grid"></div>
  </div>

  <div class="test-section">
    <h2>Test 8.3: Error Handling</h2>
    <p>Tests error handling for various failure scenarios.</p>
    
    <div class="controls">
      <button onclick="testInvalidParameters()">Test Invalid Parameters</button>
      <button onclick="testTimeout()">Test Timeout (30s)</button>
      <button onclick="testRetryLogic()">Test Retry Logic</button>
    </div>
    
    <div id="error-results"></div>
  </div>

  <div class="test-section">
    <h2>Test 8.6: Performance</h2>
    <p>Tests generation performance and timing.</p>
    
    <div class="form-group">
      <label>Image Size:</label>
      <select id="sizeSelect">
        <option value="32">32x32</option>
        <option value="64" selected>64x64</option>
        <option value="128">128x128</option>
        <option value="256">256x256</option>
        <option value="512">512x512</option>
      </select>
    </div>
    
    <div class="controls">
      <button onclick="testPerformance()">Test Performance</button>
      <button onclick="testMultipleSizes()">Test Multiple Sizes</button>
    </div>
    
    <div id="performance-results"></div>
  </div>

  <script type="module">
    import PollinationsAPIService from './src/services/PollinationsAPIService.js';
    
    // Make service available globally for test functions
    window.apiService = new PollinationsAPIService();
    window.testResults = [];
    
    // Helper functions
    window.addResult = function(containerId, message, type = 'info') {
      const container = document.getElementById(containerId);
      const result = document.createElement('div');
      result.className = `test-result ${type}`;
      result.innerHTML = message;
      container.appendChild(result);
      container.scrollTop = container.scrollHeight;
    };
    
    window.addImage = function(containerId, imageData, metadata) {
      const container = document.getElementById(containerId);
      const card = document.createElement('div');
      card.className = 'image-card';
      
      const img = document.createElement('img');
      img.src = imageData;
      img.alt = metadata.description || 'Generated image';
      
      const info = document.createElement('div');
      info.className = 'image-info';
      info.innerHTML = `
        <div><strong>Model:</strong> ${metadata.model || 'N/A'}</div>
        <div><strong>Seed:</strong> ${metadata.seed || 'Random'}</div>
        <div><strong>Size:</strong> ${metadata.width}x${metadata.height}</div>
        <div><strong>Time:</strong> ${metadata.generationTime || 'N/A'}ms</div>
      `;
      
      card.appendChild(img);
      card.appendChild(info);
      container.appendChild(card);
    };
    
    window.clearResults = function() {
      document.getElementById('test-results').innerHTML = '';
      document.getElementById('image-results').innerHTML = '';
    };
    
    // Test 8.1: Default Generation
    window.testDefaultGeneration = async function() {
      addResult('test-results', 'üîÑ Testing default generation with turbo model...', 'info');
      
      try {
        const startTime = Date.now();
        const result = await window.apiService.generateImage({
          description: 'a small pixel art tree',
          imageSize: { width: 64, height: 64 }
        });
        const endTime = Date.now();
        
        if (result && result.imageData) {
          addResult('test-results', `‚úÖ Default generation successful! Time: ${endTime - startTime}ms`, 'success');
          addImage('image-results', result.imageData, {
            model: result.metadata.model,
            seed: result.metadata.seed,
            width: 64,
            height: 64,
            generationTime: endTime - startTime,
            description: 'pixel art tree'
          });
          
          // Verify metadata
          if (result.metadata.model === 'turbo') {
            addResult('test-results', '‚úÖ Metadata verification: Model is correctly set to "turbo"', 'success');
          } else {
            addResult('test-results', `‚ùå Metadata error: Expected model "turbo", got "${result.metadata.model}"`, 'error');
          }
        } else {
          addResult('test-results', '‚ùå Generation failed: No image data returned', 'error');
        }
      } catch (error) {
        addResult('test-results', `‚ùå Generation error: ${error.message}`, 'error');
      }
    };
    
    // Test 8.1: All Models
    window.testAllModels = async function() {
      const models = ['turbo', 'flux', 'flux-realism', 'flux-anime', 'flux-3d'];
      addResult('test-results', `üîÑ Testing all ${models.length} models...`, 'info');
      
      for (const model of models) {
        try {
          addResult('test-results', `Testing model: ${model}...`, 'info');
          const startTime = Date.now();
          
          const result = await window.apiService.generateImage({
            description: 'a small pixel art house',
            imageSize: { width: 64, height: 64 },
            model: model
          });
          
          const endTime = Date.now();
          
          if (result && result.imageData) {
            addResult('test-results', `‚úÖ Model "${model}" successful! Time: ${endTime - startTime}ms`, 'success');
            addImage('image-results', result.imageData, {
              model: result.metadata.model,
              seed: result.metadata.seed,
              width: 64,
              height: 64,
              generationTime: endTime - startTime,
              description: `house (${model})`
            });
          } else {
            addResult('test-results', `‚ùå Model "${model}" failed: No image data`, 'error');
          }
        } catch (error) {
          addResult('test-results', `‚ùå Model "${model}" error: ${error.message}`, 'error');
        }
      }
      
      addResult('test-results', '‚úÖ All models test complete!', 'success');
    };
    
    // Test 8.2: Seed Reproducibility
    window.testSeedReproducibility = async function() {
      const seed = parseInt(document.getElementById('seedInput').value);
      const container = document.getElementById('seed-results');
      const imageContainer = document.getElementById('seed-images');
      container.innerHTML = '';
      imageContainer.innerHTML = '';
      
      addResult('seed-results', `üîÑ Testing seed reproducibility with seed: ${seed}...`, 'info');
      
      try {
        // Generate first image
        addResult('seed-results', 'Generating first image...', 'info');
        const result1 = await window.apiService.generateImage({
          description: 'a pixel art sword',
          imageSize: { width: 64, height: 64 },
          seed: seed
        });
        
        if (!result1 || !result1.imageData) {
          addResult('seed-results', '‚ùå First generation failed', 'error');
          return;
        }
        
        addImage('seed-images', result1.imageData, {
          model: result1.metadata.model,
          seed: result1.metadata.seed,
          width: 64,
          height: 64,
          description: 'sword (attempt 1)'
        });
        
        // Generate second image with same parameters
        addResult('seed-results', 'Generating second image with same seed...', 'info');
        const result2 = await window.apiService.generateImage({
          description: 'a pixel art sword',
          imageSize: { width: 64, height: 64 },
          seed: seed
        });
        
        if (!result2 || !result2.imageData) {
          addResult('seed-results', '‚ùå Second generation failed', 'error');
          return;
        }
        
        addImage('seed-images', result2.imageData, {
          model: result2.metadata.model,
          seed: result2.metadata.seed,
          width: 64,
          height: 64,
          description: 'sword (attempt 2)'
        });
        
        // Compare results
        if (result1.imageData === result2.imageData) {
          addResult('seed-results', '‚úÖ Seed reproducibility verified! Images are identical.', 'success');
        } else {
          addResult('seed-results', '‚ö†Ô∏è Images differ. Note: Pollinations may not guarantee 100% reproducibility due to server-side factors.', 'warning');
        }
        
      } catch (error) {
        addResult('seed-results', `‚ùå Seed test error: ${error.message}`, 'error');
      }
    };
    
    // Test 8.2: Random Generation
    window.testRandomGeneration = async function() {
      const container = document.getElementById('seed-results');
      const imageContainer = document.getElementById('seed-images');
      container.innerHTML = '';
      imageContainer.innerHTML = '';
      
      addResult('seed-results', 'üîÑ Testing random generation (no seed)...', 'info');
      
      try {
        const result = await window.apiService.generateImage({
          description: 'a pixel art coin',
          imageSize: { width: 64, height: 64 }
        });
        
        if (result && result.imageData) {
          addResult('seed-results', '‚úÖ Random generation successful!', 'success');
          addImage('seed-images', result.imageData, {
            model: result.metadata.model,
            seed: result.metadata.seed || 'Random',
            width: 64,
            height: 64,
            description: 'coin (random)'
          });
        } else {
          addResult('seed-results', '‚ùå Random generation failed', 'error');
        }
      } catch (error) {
        addResult('seed-results', `‚ùå Random generation error: ${error.message}`, 'error');
      }
    };
    
    // Test 8.3: Invalid Parameters
    window.testInvalidParameters = async function() {
      const container = document.getElementById('error-results');
      container.innerHTML = '';
      
      addResult('error-results', 'üîÑ Testing invalid parameters...', 'info');
      
      // Test 1: Empty description
      try {
        await window.apiService.generateImage({
          description: '',
          imageSize: { width: 64, height: 64 }
        });
        addResult('error-results', '‚ùå Empty description should have thrown error', 'error');
      } catch (error) {
        addResult('error-results', `‚úÖ Empty description correctly rejected: ${error.message}`, 'success');
      }
      
      // Test 2: Invalid size (too small)
      try {
        await window.apiService.generateImage({
          description: 'test',
          imageSize: { width: 8, height: 8 }
        });
        addResult('error-results', '‚ùå Invalid size (too small) should have thrown error', 'error');
      } catch (error) {
        addResult('error-results', `‚úÖ Invalid size correctly rejected: ${error.message}`, 'success');
      }
      
      // Test 3: Invalid size (too large)
      try {
        await window.apiService.generateImage({
          description: 'test',
          imageSize: { width: 2000, height: 2000 }
        });
        addResult('error-results', '‚ùå Invalid size (too large) should have thrown error', 'error');
      } catch (error) {
        addResult('error-results', `‚úÖ Invalid size correctly rejected: ${error.message}`, 'success');
      }
      
      addResult('error-results', '‚úÖ Invalid parameter tests complete!', 'success');
    };
    
    // Test 8.3: Timeout
    window.testTimeout = async function() {
      const container = document.getElementById('error-results');
      addResult('error-results', 'üîÑ Testing timeout handling (this will take 30+ seconds)...', 'info');
      addResult('error-results', '‚è≥ Waiting for timeout...', 'warning');
      
      // Note: This test would require modifying the service to force a timeout
      // For now, we'll just document the expected behavior
      addResult('error-results', '‚ÑπÔ∏è Timeout test requires manual verification:', 'info');
      addResult('error-results', '1. Service should timeout after 30 seconds', 'info');
      addResult('error-results', '2. User-friendly error message should be displayed', 'info');
      addResult('error-results', '3. Retry option should be available', 'info');
    };
    
    // Test 8.3: Retry Logic
    window.testRetryLogic = async function() {
      const container = document.getElementById('error-results');
      addResult('error-results', 'üîÑ Testing retry logic...', 'info');
      addResult('error-results', '‚ÑπÔ∏è Retry logic test requires network simulation:', 'info');
      addResult('error-results', '1. Disconnect internet before generation', 'info');
      addResult('error-results', '2. Service should retry 3 times with exponential backoff', 'info');
      addResult('error-results', '3. Delays should be: 1s, 2s, 4s', 'info');
      addResult('error-results', '4. Final error should be user-friendly', 'info');
    };
    
    // Test 8.6: Performance
    window.testPerformance = async function() {
      const size = parseInt(document.getElementById('sizeSelect').value);
      const container = document.getElementById('performance-results');
      container.innerHTML = '';
      
      addResult('performance-results', `üîÑ Testing performance with ${size}x${size} image...`, 'info');
      
      try {
        const startTime = Date.now();
        const result = await window.apiService.generateImage({
          description: 'a pixel art character',
          imageSize: { width: size, height: size }
        });
        const endTime = Date.now();
        const duration = endTime - startTime;
        
        if (result && result.imageData) {
          addResult('performance-results', `‚úÖ Generation completed in ${duration}ms (${(duration/1000).toFixed(2)}s)`, 'success');
          
          // Check performance expectations
          if (duration < 30000) {
            addResult('performance-results', '‚úÖ Performance: Within 30-second timeout', 'success');
          } else {
            addResult('performance-results', '‚ùå Performance: Exceeded 30-second timeout', 'error');
          }
          
          if (duration < 15000) {
            addResult('performance-results', '‚úÖ Performance: Fast generation (< 15s)', 'success');
          } else if (duration < 30000) {
            addResult('performance-results', '‚ö†Ô∏è Performance: Acceptable but slow (15-30s)', 'warning');
          }
          
          // Check image size
          const imageSizeKB = (result.imageData.length * 0.75) / 1024;
          addResult('performance-results', `‚ÑπÔ∏è Image size: ${imageSizeKB.toFixed(2)} KB`, 'info');
          
        } else {
          addResult('performance-results', '‚ùå Generation failed', 'error');
        }
      } catch (error) {
        addResult('performance-results', `‚ùå Performance test error: ${error.message}`, 'error');
      }
    };
    
    // Test 8.6: Multiple Sizes
    window.testMultipleSizes = async function() {
      const sizes = [32, 64, 128, 256];
      const container = document.getElementById('performance-results');
      container.innerHTML = '';
      
      addResult('performance-results', `üîÑ Testing multiple sizes: ${sizes.join(', ')}...`, 'info');
      
      for (const size of sizes) {
        try {
          addResult('performance-results', `Testing ${size}x${size}...`, 'info');
          const startTime = Date.now();
          
          const result = await window.apiService.generateImage({
            description: 'a pixel art gem',
            imageSize: { width: size, height: size }
          });
          
          const endTime = Date.now();
          const duration = endTime - startTime;
          
          if (result && result.imageData) {
            addResult('performance-results', `‚úÖ ${size}x${size}: ${duration}ms (${(duration/1000).toFixed(2)}s)`, 'success');
          } else {
            addResult('performance-results', `‚ùå ${size}x${size}: Failed`, 'error');
          }
        } catch (error) {
          addResult('performance-results', `‚ùå ${size}x${size}: ${error.message}`, 'error');
        }
      }
      
      addResult('performance-results', '‚úÖ Multiple sizes test complete!', 'success');
    };
    
    // Initial message
    addResult('test-results', '‚ÑπÔ∏è Test suite loaded. Click buttons to run tests.', 'info');
  </script>
</body>
</html>
